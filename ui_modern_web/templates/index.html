<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Heystive MVP</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>Heystive MVP</h1>
  <p>Backend: <code>{{ BACKEND_URL }}</code></p>

  <div class="row">
    <button id="ping">Ping</button>
    <button id="ws">Open WS</button>
    <button id="send" disabled>Send "hello"</button>
    <button id="wake">Wake</button>
  </div>

  <hr/>

  <h3>Ask</h3>
  <div class="row">
    <input id="ask_text" type="text" placeholder="Ask (time, math, open url)"/>
    <button id="ask">Send</button>
  </div>

  <h3>STT</h3>
  <div class="row">
    <input id="wavfile" type="file" accept="audio/wav"/>
    <input id="stt_text" type="text" placeholder="Demo text (optional)"/>
    <button id="stt">Transcribe / Echo</button>
  </div>

  <h3>TTS</h3>
  <div class="row">
    <input id="tts_text" type="text" placeholder="Type something"/>
    <input id="tts_voice" type="text" placeholder="Voice (optional)"/>
    <button id="tts">Speak</button>
    <audio id="player" controls></audio>
  </div>

  <div id="log"></div>

  <script>
  const backend = "{{ BACKEND_URL }}";
  const wsUrl = "{{ WS_URL }}/ws";
  const log = (t)=>{ const el=document.getElementById('log'); el.textContent += t+"\\n"; };

  document.getElementById('ping').onclick = async ()=>{
    try{ const r = await fetch(backend + "/ping"); const j = await r.json(); log("ping: " + JSON.stringify(j)); }
    catch(e){ log("ping error"); }
  };

  document.getElementById('wake').onclick = async ()=>{
    try{ const r = await fetch(backend + "/api/wake"); const j = await r.json(); log("wake: " + JSON.stringify(j)); }
    catch(e){ log("wake error"); }
  };

  let sock=null;
  document.getElementById('ws').onclick = ()=>{
    sock = new WebSocket(wsUrl);
    sock.onopen = ()=>{ log("ws open"); document.getElementById('send').disabled=false; };
    sock.onmessage = (ev)=> log("ws msg: " + ev.data);
    sock.onclose = ()=>{ log("ws closed"); document.getElementById('send').disabled=true; };
    sock.onerror = ()=> log("ws error");
  };
  document.getElementById('send').onclick = ()=>{
    if(sock && sock.readyState===1){ sock.send("hello"); }
  };

  async function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(r.result.split(',')[1]);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  document.getElementById('ask').onclick = async ()=>{
    const text = document.getElementById('ask_text').value || "";
    if(!text){ log("ask: empty"); return; }
    const r = await fetch(backend + "/api/intent", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text})});
    const j = await r.json();
    log("intent: " + JSON.stringify(j));
  };

  document.getElementById('stt').onclick = async ()=>{
    const f = document.getElementById('wavfile').files[0];
    const demoText = document.getElementById('stt_text').value;
    let body = {};
    if (demoText) body.text = demoText;
    if (f) body.audio_base64 = await fileToBase64(f);
    const r = await fetch(backend + "/api/stt", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const j = await r.json();
    log("stt: " + JSON.stringify(j));
  };

  document.getElementById('tts').onclick = async ()=>{
    const text = document.getElementById('tts_text').value || "Hello from Heystive";
    const voice = document.getElementById('tts_voice').value || null;
    const r = await fetch(backend + "/api/tts", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(voice ? {text, voice} : {text})});
    const j = await r.json();
    if(j.audio_base64){
      const src = "data:audio/wav;base64," + j.audio_base64;
      const player = document.getElementById('player');
      player.src = src;
      player.play().catch(()=>{});
      log("tts: engine=" + j.engine + ", bytes=" + j.audio_base64.length + (j.voice ? ", voice="+j.voice : ""));
    }else{
      log("tts demo: " + JSON.stringify(j));
    }
  };
  </script>
</body>
</html>