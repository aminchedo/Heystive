{% extends "base.html" %}

{% block title %}Ø±Ø§Ø¨Ø· ØµÙˆØªÛŒ - Ø¯Ø³ØªÛŒØ§Ø± ØµÙˆØªÛŒ Ø§Ø³ØªÛŒÙˆ{% endblock %}
{% block page_title %}Ø±Ø§Ø¨Ø· ØµÙˆØªÛŒ{% endblock %}

{% block extra_css %}
<style>
    .voice-interface {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .voice-section {
        margin-bottom: var(--space-8);
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: var(--space-4);
        margin: var(--space-6) 0;
    }
    
    .quick-action {
        background: var(--surface);
        border: 1px solid var(--outline);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-fast);
        text-decoration: none;
        color: inherit;
    }
    
    .quick-action:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--persian-blue);
    }
    
    .quick-action-icon {
        font-size: var(--font-3xl);
        margin-bottom: var(--space-2);
    }
    
    .quick-action-title {
        font-weight: 600;
        margin-bottom: var(--space-1);
    }
    
    .quick-action-desc {
        font-size: var(--font-sm);
        color: #718096;
    }
    
    .chat-section {
        background: var(--surface);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        box-shadow: var(--shadow-md);
        margin-top: var(--space-6);
    }
    
    .chat-input-container {
        display: flex;
        gap: var(--space-3);
        align-items: flex-end;
        margin-top: var(--space-4);
    }
    
    .chat-input-wrapper {
        flex: 1;
        position: relative;
    }
    
    #chat-input {
        width: 100%;
        min-height: 50px;
        max-height: 150px;
        padding: var(--space-3) var(--space-4);
        border: 1px solid var(--outline);
        border-radius: var(--radius-lg);
        font-family: 'Vazir', sans-serif;
        font-size: var(--font-base);
        resize: vertical;
        direction: rtl;
        text-align: right;
    }
    
    #chat-input:focus {
        outline: none;
        border-color: var(--persian-blue);
        box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
    }
    
    .voice-level-container {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin: var(--space-4) 0;
        border: 1px solid var(--outline);
    }
    
    .voice-level-label {
        font-size: var(--font-sm);
        color: #718096;
        margin-bottom: var(--space-2);
        text-align: center;
    }
    
    #voice-level {
        width: 100%;
        height: 8px;
        background: var(--outline);
        border-radius: var(--radius-sm);
        overflow: hidden;
        position: relative;
    }
    
    #voice-level::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--success), var(--warning), var(--error));
        border-radius: var(--radius-sm);
        transition: width var(--transition-fast);
    }
    
    .wake-word-indicator {
        position: fixed;
        top: var(--space-4);
        left: var(--space-4);
        background: var(--surface);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        z-index: 1000;
        opacity: 0.9;
        transition: all var(--transition-normal);
        font-size: var(--font-sm);
    }
    
    .wake-word-indicator.listening {
        background: var(--success);
        color: white;
    }
    
    .wake-word-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
    }
    
    .wake-word-indicator.listening .wake-word-dot {
        background: white;
        animation: pulse 1s infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="voice-interface">
    <!-- Wake Word Indicator -->
    <div id="wake-word-indicator" class="wake-word-indicator">
        <div class="wake-word-dot"></div>
        <span class="wake-word-text">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ú©Ù„Ù…Ù‡ Ø¨ÛŒØ¯Ø§Ø± Ú©Ù†Ù†Ø¯Ù‡</span>
    </div>
    
    <!-- Main Voice Control Section -->
    <section class="voice-section">
        <div class="voice-control-panel animate-fadeInUp">
            <!-- Voice Status -->
            <div class="voice-status">
                <h2 class="voice-status-text md-headline-medium text-center">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø·</h2>
                <p class="voice-status-subtext text-center" id="voice-status">
                    Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· ØµÙˆØªØŒ Ø¯Ú©Ù…Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒØ¯ ÙØ¶Ø§ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯
                </p>
            </div>
            
            <!-- Voice Button -->
            <div class="text-center">
                <button id="voice-button" class="voice-button md-fab-large" title="Ø´Ø±ÙˆØ¹ Ø¶Ø¨Ø· ØµÙˆØª (ÙØ¶Ø§)">
                    <span class="voice-button-icon">ğŸ¤</span>
                </button>
            </div>
            
            <!-- Voice Level Indicator -->
            <div class="voice-level-container">
                <div class="voice-level-label">Ø³Ø·Ø­ ØµÙˆØª</div>
                <div id="voice-level" class="voice-level"></div>
            </div>
            
            <!-- Voice Visualizer -->
            <div id="voice-visualizer" class="voice-visualizer"></div>
            
            <!-- Voice Commands Help -->
            <div class="voice-commands">
                <h3 class="voice-commands-title">Ø¯Ø³ØªÙˆØ±Ø§Øª ØµÙˆØªÛŒ</h3>
                <ul class="voice-commands-list">
                    <li>Ø³Ù„Ø§Ù… Ø§Ø³ØªÛŒÙˆ - Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</li>
                    <li>Ú†Ù‡ Ø®Ø¨Ø±ØŸ - Ø¯Ø±ÛŒØ§ÙØª Ø§Ø®Ø¨Ø§Ø±</li>
                    <li>Ù‡ÙˆØ§ Ú†Ø·ÙˆØ±Ù‡ØŸ - ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</li>
                    <li>Ø³Ø§Ø¹Øª Ú†Ù†Ø¯Ù‡ØŸ - Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ</li>
                    <li>Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù¾Ø®Ø´ Ú©Ù† - Ù¾Ø®Ø´ Ù…ÙˆØ³ÛŒÙ‚ÛŒ</li>
                    <li>Ø®Ø§Ù…ÙˆØ´ Ú©Ù† - Ø®Ø§ØªÙ…Ù‡</li>
                </ul>
            </div>
        </div>
    </section>
    
    <!-- Quick Actions -->
    <section class="voice-section">
        <h2 class="md-headline-small mb-6">Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹</h2>
        <div class="quick-actions stagger-children">
            <div class="quick-action" onclick="sendQuickCommand('time')">
                <div class="quick-action-icon">ğŸ•</div>
                <div class="quick-action-title">Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ</div>
                <div class="quick-action-desc">Ù†Ù…Ø§ÛŒØ´ Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ®</div>
            </div>
            
            <div class="quick-action" onclick="sendQuickCommand('weather')">
                <div class="quick-action-icon">ğŸŒ¤ï¸</div>
                <div class="quick-action-title">Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</div>
                <div class="quick-action-desc">ÙˆØ¶Ø¹ÛŒØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§</div>
            </div>
            
            <div class="quick-action" onclick="sendQuickCommand('news')">
                <div class="quick-action-icon">ğŸ“°</div>
                <div class="quick-action-title">Ø§Ø®Ø¨Ø§Ø±</div>
                <div class="quick-action-desc">Ø¢Ø®Ø±ÛŒÙ† Ø§Ø®Ø¨Ø§Ø±</div>
            </div>
            
            <div class="quick-action" onclick="sendQuickCommand('music')">
                <div class="quick-action-icon">ğŸµ</div>
                <div class="quick-action-title">Ù…ÙˆØ³ÛŒÙ‚ÛŒ</div>
                <div class="quick-action-desc">Ù¾Ø®Ø´ Ù…ÙˆØ³ÛŒÙ‚ÛŒ</div>
            </div>
            
            <div class="quick-action" onclick="sendQuickCommand('calculator')">
                <div class="quick-action-icon">ğŸ§®</div>
                <div class="quick-action-title">Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨</div>
                <div class="quick-action-desc">Ø§Ù†Ø¬Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø§Øª</div>
            </div>
            
            <div class="quick-action" onclick="sendQuickCommand('help')">
                <div class="quick-action-icon">â“</div>
                <div class="quick-action-title">Ø±Ø§Ù‡Ù†Ù…Ø§</div>
                <div class="quick-action-desc">Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú©</div>
            </div>
        </div>
    </section>
    
    <!-- Voice Response Display -->
    <section class="voice-section">
        <div id="voice-response" class="voice-response card" style="display: none;">
            <h3 class="md-title-medium mb-4">Ù¾Ø§Ø³Ø® Ø§Ø³ØªÛŒÙˆ</h3>
            <div id="voice-response-text" class="voice-response-text">
                Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®...
            </div>
            <div class="voice-response-actions">
                <button class="voice-response-action" onclick="playLastResponse()">
                    <span>ğŸ”Š</span> Ù¾Ø®Ø´ Ù…Ø¬Ø¯Ø¯
                </button>
                <button class="voice-response-action" onclick="copyResponse()">
                    <span>ğŸ“‹</span> Ú©Ù¾ÛŒ Ù…ØªÙ†
                </button>
                <button class="voice-response-action" onclick="shareResponse()">
                    <span>ğŸ“¤</span> Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
                </button>
            </div>
        </div>
    </section>
    
    <!-- Chat Interface -->
    <section class="chat-section animate-fadeInUp" style="animation-delay: 0.3s;">
        <h2 class="md-headline-small mb-4">Ú¯ÙØªÚ¯ÙˆÛŒ Ù…ØªÙ†ÛŒ</h2>
        
        <!-- Chat Messages -->
        <div id="chat-container" class="voice-chat"></div>
        
        <!-- Chat Input -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="chat-input" 
                    placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
                    rows="1"
                ></textarea>
            </div>
            <button id="chat-send" class="btn btn-primary" title="Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… (Enter)">
                <span>ğŸ“¤</span>
                Ø§Ø±Ø³Ø§Ù„
            </button>
        </div>
        
        <div class="text-center mt-4">
            <small class="text-muted">
                Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Enter Ùˆ Ø¨Ø±Ø§ÛŒ Ø®Ø· Ø¬Ø¯ÛŒØ¯ Shift+Enter Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯
            </small>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Quick command functions
    function sendQuickCommand(command) {
        const commands = {
            'time': 'Ø³Ø§Ø¹Øª Ú†Ù†Ø¯Ù‡ØŸ',
            'weather': 'Ù‡ÙˆØ§ Ú†Ø·ÙˆØ±Ù‡ØŸ',
            'news': 'Ú†Ù‡ Ø®Ø¨Ø±ØŸ',
            'music': 'Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù¾Ø®Ø´ Ú©Ù†',
            'calculator': 'Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨',
            'help': 'Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ø¨Ø¯Ù‡'
        };
        
        const message = commands[command] || command;
        
        if (window.heystiveApp) {
            // Add to chat
            window.heystiveApp.addChatMessage(message, 'user');
            
            // Send to assistant
            if (window.heystiveApp.websocketClient && window.heystiveApp.websocketClient.isConnected) {
                window.heystiveApp.websocketClient.sendTextMessage(message);
            } else {
                // Fallback to HTTP API
                fetch('/api/text-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(result => {
                    if (window.heystiveApp) {
                        window.heystiveApp.displayTextResponse(result);
                    }
                })
                .catch(error => {
                    console.error('Error sending quick command:', error);
                    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø³ØªÙˆØ±', 'error');
                });
            }
        }
    }
    
    // Voice response functions
    let lastAudioUrl = null;
    let lastResponseText = '';
    
    function playLastResponse() {
        if (lastAudioUrl) {
            const audio = new Audio(lastAudioUrl);
            audio.play().catch(error => {
                console.warn('Failed to play audio:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµÙˆØª', 'error');
            });
        } else {
            showNotification('ØµÙˆØªÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø®Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
        }
    }
    
    function copyResponse() {
        if (lastResponseText) {
            navigator.clipboard.writeText(lastResponseText).then(() => {
                showNotification('Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
            }).catch(error => {
                console.warn('Failed to copy text:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù…ØªÙ†', 'error');
            });
        }
    }
    
    function shareResponse() {
        if (navigator.share && lastResponseText) {
            navigator.share({
                title: 'Ù¾Ø§Ø³Ø® Ø§Ø³ØªÛŒÙˆ',
                text: lastResponseText,
                url: window.location.href
            }).catch(error => {
                console.warn('Failed to share:', error);
            });
        } else {
            // Fallback - copy to clipboard
            copyResponse();
        }
    }
    
    // Enhanced app initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-resize chat input
        const chatInput = document.getElementById('chat-input');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }
        
        // Update voice response display
        if (window.heystiveApp) {
            const originalDisplayResponse = window.heystiveApp.displayVoiceResponse;
            window.heystiveApp.displayVoiceResponse = function(result) {
                originalDisplayResponse.call(this, result);
                
                // Update response display
                const responseDiv = document.getElementById('voice-response');
                const responseText = document.getElementById('voice-response-text');
                
                if (responseDiv && responseText && result.response_text) {
                    lastResponseText = result.response_text;
                    lastAudioUrl = result.audio_url;
                    
                    responseText.textContent = result.response_text;
                    responseDiv.style.display = 'block';
                    responseDiv.classList.add('animate-fadeInUp');
                }
            };
        }
        
        // Wake word indicator simulation
        const wakeWordIndicator = document.getElementById('wake-word-indicator');
        if (wakeWordIndicator) {
            // Simulate wake word detection
            setInterval(() => {
                const isListening = Math.random() > 0.8; // 20% chance
                if (isListening) {
                    wakeWordIndicator.classList.add('listening');
                    wakeWordIndicator.querySelector('.wake-word-text').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†...';
                    
                    setTimeout(() => {
                        wakeWordIndicator.classList.remove('listening');
                        wakeWordIndicator.querySelector('.wake-word-text').textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ú©Ù„Ù…Ù‡ Ø¨ÛŒØ¯Ø§Ø± Ú©Ù†Ù†Ø¯Ù‡';
                    }, 2000);
                }
            }, 5000);
        }
        
        // Voice level visualization
        const voiceLevelElement = document.getElementById('voice-level');
        if (voiceLevelElement && window.heystiveApp) {
            const originalHandleVolumeChange = window.heystiveApp.handleVolumeChange;
            window.heystiveApp.handleVolumeChange = function(level) {
                originalHandleVolumeChange.call(this, level);
                
                // Update voice level bar
                const percentage = Math.min(level * 2, 100);
                voiceLevelElement.style.setProperty('--voice-level', `${percentage}%`);
            };
        }
        
        // Add CSS for voice level animation
        const style = document.createElement('style');
        style.textContent = `
            #voice-level::after {
                width: var(--voice-level, 0%);
            }
        `;
        document.head.appendChild(style);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // F1 for help
        if (e.key === 'F1') {
            e.preventDefault();
            sendQuickCommand('help');
        }
        
        // Ctrl+T for time
        if (e.ctrlKey && e.key === 't') {
            e.preventDefault();
            sendQuickCommand('time');
        }
        
        // Ctrl+W for weather
        if (e.ctrlKey && e.key === 'w') {
            e.preventDefault();
            sendQuickCommand('weather');
        }
    });
</script>
{% endblock %}